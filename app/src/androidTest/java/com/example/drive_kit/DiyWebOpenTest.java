package com.example.drive_kit;

import static androidx.test.espresso.Espresso.onView;
import static androidx.test.espresso.action.ViewActions.click;
import static androidx.test.espresso.assertion.ViewAssertions.matches;
import static androidx.test.espresso.intent.Intents.init;
import static androidx.test.espresso.intent.Intents.intended;
import static androidx.test.espresso.intent.Intents.release;
import static androidx.test.espresso.intent.matcher.IntentMatchers.hasAction;
import static androidx.test.espresso.intent.matcher.IntentMatchers.hasData;
import static androidx.test.espresso.intent.matcher.IntentMatchers.hasExtraWithKey;
import static androidx.test.espresso.matcher.ViewMatchers.isDisplayed;
import static androidx.test.espresso.matcher.ViewMatchers.withId;
import static androidx.test.espresso.intent.matcher.IntentMatchers.hasDataString;

import android.content.Intent;
import android.os.SystemClock;

import androidx.test.core.app.ActivityScenario;
import androidx.test.espresso.contrib.RecyclerViewActions;

import com.example.drive_kit.View.HomeActivity;
import com.google.android.gms.tasks.Tasks;
import com.google.firebase.auth.FirebaseAuth;

import org.hamcrest.Matchers;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import java.util.concurrent.TimeUnit;

public class DiyWebOpenTest {

    private static final String EMAIL = "test@gmail.com";
    private static final String PASS  = "Aa123456!";

    @Before
    public void setUp() {
        init(); // Espresso-Intents
    }

    @After
    public void tearDown() {
        release();
    }

    @Test
    public void diyFlow_myCar_search_thenDownloadManual_opensWebPage() throws Exception {
        // 1) sign in
        FirebaseAuth auth = FirebaseAuth.getInstance();
        auth.signOut();
        Tasks.await(auth.signInWithEmailAndPassword(EMAIL, PASS), 20, TimeUnit.SECONDS);

        // 2) open Home
        try (ActivityScenario<HomeActivity> scenario = ActivityScenario.launch(HomeActivity.class)) {

            // 3) open DIY from Home
            onView(withId(R.id.circleDIY)).perform(click());

            // 4) choose "הרכב שלי" in DIYFilterActivity
            onView(withId(R.id.myCarButton)).perform(click());

            // 5) wait 3 sec to load
            SystemClock.sleep(3000);

            // 6) choose "חפש"
            onView(withId(R.id.searchButton)).perform(click());

            // 7) now on DIYIssuesActivity - wait 5 sec
            SystemClock.sleep(5000);

            // ensure button is visible
            onView(withId(R.id.btnDownloadManual)).check(matches(isDisplayed()));

            // 8) click "ספר רכב (PDF)" (בפועל פותח URL בדפדפן)
            onView(withId(R.id.btnDownloadManual)).perform(click());

            // 9) assert: נשלח Intent לפתיחת דף אינטרנט
            intended(Matchers.anyOf(
                    // מקרה 1: ACTION_VIEW עם URL ישירות
                    Matchers.allOf(
                            hasAction(Intent.ACTION_VIEW),
                            hasDataString(Matchers.anyOf(
                                    Matchers.startsWith("https://"),
                                    Matchers.startsWith("http://")
                            ))
                    ),
                    // מקרה 2: עטוף בתוך chooser
                    Matchers.allOf(
                            hasAction(Intent.ACTION_CHOOSER),
                            hasExtraWithKey(Intent.EXTRA_INTENT)
                    )
            ));
        }
    }


    @Test
    public void diyFlow_clickFirstVideo_opensWebPage() throws Exception {
        // 1) sign in
        FirebaseAuth auth = FirebaseAuth.getInstance();
        auth.signOut();
        Tasks.await(auth.signInWithEmailAndPassword(EMAIL, PASS), 20, TimeUnit.SECONDS);

        // 2) open Home
        try (ActivityScenario<HomeActivity> scenario = ActivityScenario.launch(HomeActivity.class)) {

            // 3) open DIY
            onView(withId(R.id.circleDIY)).perform(click());

            // 4) "הרכב שלי"
            onView(withId(R.id.myCarButton)).perform(click());

            // 5) wait load
            SystemClock.sleep(3000);

            // 6) search
            onView(withId(R.id.searchButton)).perform(click());

            // 7) wait DIYIssuesActivity load
            SystemClock.sleep(5000);

            // ensure recycler is visible
            onView(withId(R.id.issuesRecycler)).check(matches(isDisplayed()));

            // 8) click first item (first video/issue)
            onView(withId(R.id.issuesRecycler))
                    .perform(RecyclerViewActions.actionOnItemAtPosition(0, click()));

            // 9) assert: opened a web page (video link) via intent
            intended(Matchers.anyOf(
                    // ACTION_VIEW with URL
                    Matchers.allOf(
                            hasAction(Intent.ACTION_VIEW),
                            hasDataString(Matchers.anyOf(
                                    Matchers.startsWith("https://"),
                                    Matchers.startsWith("http://")
                            ))
                    ),
                    // or wrapped in chooser
                    Matchers.allOf(
                            hasAction(Intent.ACTION_CHOOSER),
                            hasExtraWithKey(Intent.EXTRA_INTENT)
                    )
            ));
        }
    }
}